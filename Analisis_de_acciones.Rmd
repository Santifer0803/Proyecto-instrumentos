---
title: "Analisis_de_acciones"
author: "Grupo de criptomonedas"
date: "`r Sys.Date()`"
output: html_document
---

# Librerías

Se cargan las librerías necesarias.

```{r librerias}
pacman::p_load(corrplot,
               readxl,
               tidyverse,
               xtable)
```

# Descarga de datos

Se cargan los datos de los activos necesarios.

```{r datos}
# Criptomonedas
datos.bitcoin.original <- read_excel("data/Datos históricos del Bitcoin.xlsx")
datos.ethereum <- read_excel("data/Datos históricos del Ethereum.xlsx")

# Acciones de empresas
datos.apple <- read_excel("data/Apple.xlsx")
datos.nvidia <- read_excel("data/NVIDIA.xlsx")
```

# Correcciones en las bases de datos

Se corrigen algunas características de las bases de datos a utilizar.

```{r correcciones_generales, warning = FALSE, message = FALSE}
# Formato de fecha
datos.bitcoin.original$Fecha <-
  as.Date(datos.bitcoin.original$Fecha, format = "%d.%m.%Y")

datos.ethereum$Fecha <-
  as.Date(datos.ethereum$Fecha, format = "%d.%m.%Y")

datos.nvidia$Date <-
  as.Date(datos.nvidia$Date, format = "%d.%m.%Y")

datos.apple$Date <- 
  as.Date(datos.apple$Date, format = "%d.%m,%Y")
```


```{r correcciones_datos_criptomonedas, warning = FALSE, message = FALSE}
# Se agregan columnas con el volumen en números para el bitcoin
datos.bitcoin.original <- datos.bitcoin.original %>%
  mutate(
    miles = as.numeric(gsub("K", "", datos.bitcoin.original$Vol)) * 1000,
    millones = as.numeric(gsub("M", "", datos.bitcoin.original$Vol)) * 1000000,
    billones = as.numeric(gsub("B", "", datos.bitcoin.original$Vol)) * 1000000000
  )

# Se juntan las columnas en una sola
datos.bitcoin.original$Vol <-
  ifelse(
    !is.na(datos.bitcoin.original$miles),
    datos.bitcoin.original$miles,
    ifelse(
      !is.na(datos.bitcoin.original$millones),
      datos.bitcoin.original$millones,
      ifelse(
        !is.na(datos.bitcoin.original$billones),
        datos.bitcoin.original$billones,
        NA
      )
    )
  )

# Se eliminan las columnas innecesarias
datos.bitcoin.original <- datos.bitcoin.original %>%
  select(-c("miles", "millones", "billones"))

# Se agregan columnas con el volumen en números para el ethereum
datos.ethereum <- datos.ethereum %>%
  mutate(
    miles = as.numeric(gsub("K", "", datos.ethereum$Vol)) * 1000,
    millones = as.numeric(gsub("M", "", datos.ethereum$Vol)) * 1000000,
    billones = as.numeric(gsub("B", "", datos.ethereum$Vol)) * 1000000000
  )

# Se juntan las columnas en una sola
datos.ethereum$Vol <-
  ifelse(
    !is.na(datos.ethereum$miles),
    datos.ethereum$miles,
    ifelse(
      !is.na(datos.ethereum$millones),
      datos.ethereum$millones,
      ifelse(!is.na(datos.ethereum$billones), datos.ethereum$billones, NA)
    )
  )

# Se eliminan las columnas innecesarias
datos.ethereum <- datos.ethereum %>%
  select(-c("miles", "millones", "billones"))

# Se rellenan los valores nulos con el último conocido
datos.ethereum <- datos.ethereum %>%
  fill(Vol, .direction = "up")

# Nombres de las columnas
colnames(datos.bitcoin.original) <-
  c("fecha",
    "ultimo",
    "apertura",
    "maximo",
    "minimo",
    "volumen",
    "variacion")

colnames(datos.ethereum) <-
  c("fecha",
    "ultimo",
    "apertura",
    "maximo",
    "minimo",
    "volumen",
    "variacion")

```


```{r correcciones_datos_nvidia, warning = FALSE, message = FALSE}
# Se elimina la columna del último precio ajustado de la base de NVIDIA
datos.nvidia <- datos.nvidia %>%
  select(-c("Adj Close"))


# Se agrega la columna de variación porcentual a la base de NVIDIA
datos.nvidia <- datos.nvidia %>%
  mutate(variacion = ((Close / lag(Close)) - 1))

# Se intercambian las columnas de la base de NVIDIA
datos.nvidia <- datos.nvidia %>%
  select(Date, Close, Open, High, Low, Volume, variacion)

# Se invierte el orden de las filas de la base de NVIDIA para que estén iguales
# las demás
datos.nvidia <- datos.nvidia[rev(rownames(datos.nvidia)), ]

# Nombres de las columnas
colnames(datos.nvidia) <-
  c("fecha",
    "ultimo",
    "apertura",
    "maximo",
    "minimo",
    "volumen",
    "variacion")
```

```{r correcciones_datos_apple}

# Se elimina la columna del último precio ajustado de la base de Apple
datos.apple <- datos.apple %>%
  select(-c("Adj Close"))

# Se agrega la columna de variación porcentual a la base de NVIDIA
datos.apple <- datos.apple %>%
  mutate(variacion = ((Close / lag(Close)) - 1))

# Se intercambian las columnas de la base de Apple
datos.apple <- datos.apple %>%
  select(Date, Close, Open, High, Low, Volume, variacion)


# Se invierte el orden de las filas de la base de NVIDIA para que estén iguales
# las demás
datos.apple <- datos.apple[rev(rownames(datos.apple)), ]

#Nombre de las columnas
colnames(datos.apple) <-
  c("fecha",
    "ultimo",
    "apertura",
    "maximo",
    "minimo",
    "volumen",
    "variacion")

```



# Comparación de criptomonedas

Se extienden las bases del bitcoin y del ethereum para tener algunas estadísticas descriptivas.

```{r union_bases}
# Se comparan la misma cantidad de fechas de los activos.
datos.bitcoin <- datos.bitcoin.original[1:nrow(datos.ethereum), ]

# Datos del bitcoin extendidos
resumen.btc <- datos.bitcoin %>%
  pivot_longer(-c(fecha))

# Datos del ethereum extendidos
resumen.etr <- datos.ethereum %>%
  pivot_longer(-c(fecha))
```

Se procede a realizar una tabla resumen de las criptomonedas.

```{r resumen_criptos}
# Resumen del bitcoin
resumen.btc <- resumen.btc %>%
  group_by(name) %>%
  summarise(
    promedio = mean(value, na.rm = TRUE),
    minimo = min(value, na.rm = TRUE),
    mediana = quantile(value, 0.5),
    maximo = max(value, na.rm = TRUE),
    desviacion = sd(value, na.rm = TRUE)
  )

# Resumen del ethereum
resumen.etr <- resumen.etr %>%
  group_by(name) %>%
  summarise(
    promedio = mean(value, na.rm = TRUE),
    minimo = min(value, na.rm = TRUE),
    mediana = quantile(value, 0.5),
    maximo = max(value, na.rm = TRUE),
    desviacion = sd(value, na.rm = TRUE)
  )
```

Hacemos una matriz de correlación para observar si el comportamiento de las 2 criptomonedas tiene relación.

```{r correlacion}
# Correlaciones individuales
correlaciones.btc <- cor(datos.bitcoin[, -1], datos.bitcoin[, -1])
correlaciones.etr <- cor(datos.ethereum[, -1], datos.ethereum[, -1])

# Correlaciones cruzadas
correlaciones.cruz <- cor(datos.bitcoin[, -1], datos.ethereum[, -1])
```

Se realizan los gráficos de las matrices de correlación.

```{r graficos_corr_cripto}
# Output de los gráficos
par(mfrow = c(1, 2))

# Correlación del bitcoin
corrplot(
  correlaciones.btc,
  method = "color",
  type = "upper",
  order = "hclust",
  addCoef.col = "lightcoral",
  number.cex = 0.7,
  number.digits = 3
)

# Correlación de ethereum
corrplot(
  correlaciones.etr,
  method = "color",
  type = "upper",
  order = "hclust",
  addCoef.col = "lightcoral",
  number.cex = 0.7,
  number.digits = 3
)
```

```{r corr_cruzado_cripto}
# Correlaciones cruzadas
corrplot(
  correlaciones.cruz,
  method = "color",
  type = "upper",
  order = "hclust",
  addCoef.col = "lightcoral",
  number.cex = 0.7,
  number.digits = 3
)
```


Se realiza un gráfico comparativo de las variaciones diarias del bitcoin y de ethereum.

```{r comparacion_variaciones}
# Dataframe auxiliar
df.auxiliar <-
  as.data.frame(cbind(
    datos.bitcoin$fecha,
    datos.bitcoin$variacion,
    datos.ethereum$variacion
  ))

# Se corrigen los formatos de columna
colnames(df.auxiliar) <- c("fecha", "cambio_btc", "cambio_etr")

# Formato de fecha
df.auxiliar$fecha <- as.Date(df.auxiliar$fecha, format = "%d.%m.%Y")

# Diferencias de las variaciones
df.auxiliar <- df.auxiliar %>%
  mutate(diferencia = abs(cambio_btc - cambio_etr))

# Gráfico comparativo de varianzas diarias
ggplot(df.auxiliar, aes(x = fecha)) +
  geom_line(aes(y = diferencia),
            color = "orangered2",
            linewidth = 0.5) +
  labs(x = "Tiempo", y = "Diferencia de las variaciones", 
       caption = "Fuente: Elaboración propia") +
  theme_minimal()
```

Se imprimen las tablas correspondientes.

```{r impresion_tablas}
# Se corrigen los nombres
colnames(resumen.btc)[1] <- "variable"
colnames(resumen.etr)[1] <- "variable"

# Creamos las tablas
tabla.btc <- xtable(resumen.btc)
tabla.etr <- xtable(resumen.etr)

# Las imprimimos
print(tabla.btc, type = "latex", digits = 4)
print(tabla.etr, type = "latex", digits = 4)
```

# Comparación del Bitcoin con NVIDIA

Se tienen que guardar las observaciones de ambos activos en las fechas en común.

```{r filtrar_nvidia}
# Se calcula la diferencia de días entre la última fecha del bitcoin y la
# última fecha de NVIDIA
diferencia_dias <-
  as.numeric(datos.bitcoin.original$fecha[1] - datos.nvidia$fecha[1]) + 1

# Seleccionamos las observaciones del bitcoin usando la diferencia de días
datos.bitcoin <-
  datos.bitcoin.original[diferencia_dias:nrow(datos.bitcoin.original), ]

# Filtramos los datos del bitcoin para que coincidan con la misma fecha que los
# de NVIDIA
datos.bitcoin <- datos.bitcoin[datos.bitcoin$fecha %in% datos.nvidia$fecha, ]

# Seleccionamos los datos de NVIDIA a partir de la fecha del primer dato del bitcoin
datos.nvidia <- datos.nvidia[1:nrow(datos.bitcoin), ]
```

Pivoteamos los datos del Bitcoin y de las acciones.

```{r}
# Datos del bitcoin extendidos
resumen.btc <- datos.bitcoin %>%
  pivot_longer(-c(fecha))

# Datos de nvidia extendidos
resumen.nvidia <- datos.nvidia %>%
  pivot_longer(-c(fecha))
```

Calculamos algunas estadísticas descriptivas de ambos intrumentos. 

```{r}
# Resumen del bitcoin
resumen.btc <- resumen.btc %>%
  group_by(name) %>%
  summarise(
    promedio = mean(value, na.rm = TRUE),
    minimo = min(value, na.rm = TRUE),
    mediana = quantile(value, 0.5),
    maximo = max(value, na.rm = TRUE),
    desviacion = sd(value, na.rm = TRUE)
  )

# Resumen de NVIDIA
resumen.nvidia <- resumen.nvidia %>%
  group_by(name) %>%
  summarise(
    promedio = mean(value, na.rm = TRUE),
    minimo = min(value, na.rm = TRUE),
    mediana = quantile(value, 0.5),
    maximo = max(value, na.rm = TRUE),
    desviacion = sd(value, na.rm = TRUE)
  )
```

Calculamos las correlaciones individuales y conjunta.

```{r}
# Correlaciones individuales
correlaciones.btc <- cor(datos.bitcoin[, -1], datos.bitcoin[, -1])
correlaciones.nvidia <- cor(datos.nvidia[, -1], datos.nvidia[, -1])

# Correlaciones cruzadas
correlaciones.cruz <- cor(datos.bitcoin[, -1], datos.nvidia[, -1])
```

Graficamos las correlaciones.

```{r}
# Output de los gráficos
par(mfrow = c(1, 2))

# Correlación del bitcoin
corrplot(
  correlaciones.btc,
  method = "color",
  type = "upper",
  order = "hclust",
  addCoef.col = "lightcoral",
  number.cex = 0.7,
  number.digits = 3
)

# Correlación de NVIDIA
corrplot(
  correlaciones.nvidia,
  method = "color",
  type = "upper",
  order = "hclust",
  addCoef.col = "lightcoral",
  number.cex = 0.7,
  number.digits = 3
)

# Correlaciones cruzadas
corrplot(
  correlaciones.cruz,
  method = "color",
  type = "upper",
  order = "hclust",
  addCoef.col = "lightcoral",
  number.cex = 0.7,
  number.digits = 3
)
```

Seguidamente realizamos el gráfico de la diferencia de las variaciones de cada instrumento.

```{r}
# Dataframe auxiliar
df.auxiliar <-
  as.data.frame(cbind(
    datos.bitcoin$fecha,
    datos.bitcoin$variacion,
    datos.nvidia$variacion
  ))

# Se corrigen los formatos de columna
colnames(df.auxiliar) <- c("fecha", "cambio_btc", "cambio_nvidia")

# Formato de fecha
df.auxiliar$fecha <- as.Date(df.auxiliar$fecha, format = "%d.%m.%Y")

# Diferencias de las variaciones
df.auxiliar <- df.auxiliar %>%
  mutate(diferencia = abs(cambio_btc - cambio_nvidia))

# Gráfico comparativo de varianzas diarias
ggplot(df.auxiliar, aes(x = fecha)) +
  geom_line(aes(y = diferencia),
            color = "royalblue",
            linewidth = 0.5) +
  labs(x = "Tiempo", y = "Diferencia de las variaciones", 
       caption = "Fuente: Elaboración propia") +
  theme_minimal()
```

Por último, imprimimos las tablas correspondientes.

```{r}
# Se corrigen los nombres
colnames(resumen.btc)[1] <- "variable"
colnames(resumen.nvidia)[1] <- "variable"

# Creamos las tablas
tabla.btc <- xtable(resumen.btc)
tabla.nvidia <- xtable(resumen.nvidia)

# Las imprimimos
print(tabla.btc, type = "latex", digits = 4)
print(tabla.nvidia, type = "latex", digits = 4)
```


